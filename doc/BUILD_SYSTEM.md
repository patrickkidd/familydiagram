# Build System Architecture

This document explains how Family Diagram's build system uses pyqtdeploy and qmake to produce deterministic Xcode projects for macOS and iOS builds.

## Overview

The build pipeline follows this flow:

```
familydiagram.pdt (pyqtdeploy project)
        │
        ▼
  pyqtdeploy-build
        │
        ▼
  build/{osx,ios}/Family Diagram.pro (generated)
        │
        ▼ (+ *.pri config files)
      qmake
        │
        ▼
  Family Diagram.xcodeproj
        │
        ▼
    xcodebuild
        │
        ▼
  Family Diagram.app
```

## Key Configuration Files

### pyqtdeploy Configuration

**`familydiagram.pdt`** (TOML format) - The master pyqtdeploy project definition:

- **`sysroot`**: Points to `sysroot/sysroot.toml` for dependency versions
- **`parts`**: Lists all Python/PyQt modules to include (stdlib, PyQt5, third-party wheels)
- **`[Application]`**: Defines entry point (`pkdiagram.main:main`), app name, bundle settings
- **`qmake_configuration`**: Injects `include($$PWD/../../build/common-config/common.pri)` into generated .pro files
- **`[Application.Package]`**: Specifies the `pkdiagram` package with include/exclude patterns

**`sysroot/sysroot.toml`** - Defines exact versions for all dependencies:

| Component | Version | Notes |
|-----------|---------|-------|
| OpenSSL | 1.1.1g | Disabled on iOS (uses SecureTransport) |
| zlib | 1.3.1 | Built from source |
| Python | 3.11.6 | Host build from source on iOS |
| Qt | 5.15.16 (macOS), 5.15.2 (iOS) | Static build from source on macOS |
| PyQt | 5.15.11 | Installed modules vary by platform |
| SIP | abi_major_version=12 | Module name: `PyQt5.sip` |

### Sysroot Plugins

Custom sysroot plugins in `sysroot/*.py` define how components are built:

- **`_pkdiagram.py`**: Defines the `_pkdiagram` C++ extension module
  - Source files: `_pkdiagram.cpp`, `_pkdiagram_mac.mm` (or `_win32.cpp`)
  - SIP-generated bindings in `build/_pkdiagram/sip_*.cpp`
  - MOC-generated files: `moc_unsafearea.cpp`, `moc__pkdiagram.cpp`
  - Preinstalls: Python, PyQt, Qt, SIP

- **`btcopilot.py`**: Provides the btcopilot Python package
  - Pure Python package, no compilation needed

### qmake Configuration Hierarchy

```
build/osx/Family Diagram.pro    (generated by pyqtdeploy-build)
    │
    └── include($$PWD/../../build/common-config/common.pri)
            │
            ├── (macOS) include(../osx/osx.pri)
            │       └── osx-config/osx.pri
            │
            ├── (iOS) include(../ios/ios.pri)
            │       └── ios-config/ios.pri
            │
            └── (Win32) include(../win32/win32.pri)
```

**`build/common-config/common.pri`** - Shared across platforms:
- Entitlements configuration (`CODE_SIGN_ENTITLEMENTS`)
- Info.plist path
- App icon
- Precompiled header setup
- Build type defines (`PK_BETA_BUILD`, `PK_ALPHA_BUILD`)

**`build/osx-config/osx.pri`** - macOS-specific:
- Bugsnag and Sparkle framework bundling
- Code signing identity and provisioning profile
- Debug symbol generation (`DWARF_DSYM_FILE_NAME`)
- Hardened runtime settings
- Bundle identifier (`com.vedanamedia.familydiagrammac`)

**`build/ios-config/ios.pri`** - iOS-specific:
- Bundle identifier (`com.vedanamedia.familydiagram`)
- Development team and provisioning
- Settings.bundle and Assets.xcassets

## Generated .pro File Structure

After `pyqtdeploy-build`, the generated `build/osx/Family Diagram.pro` contains:

1. **Qt Modules**: `QT += quickwidgets gui widgets quick network printsupport qml`

2. **Resources**: Multiple `.qrc` files containing frozen Python bytecode
   ```
   RESOURCES = resources/pyqtdeploy0.qrc ... pyqtdeploy11.qrc
   ```

3. **Defines**: `PYQTDEPLOY_OPTIMIZED`, `Py_BUILD_CORE_MODULE`, etc.

4. **Include Paths**: Sysroot headers, Python internals, _pkdiagram sources

5. **Sources**:
   - `pyqtdeploy_main.cpp` - Module initialization table
   - `pyqtdeploy_start.cpp` - Python interpreter bootstrap
   - `pdytools_module.cpp` - Qt resource importer for frozen modules
   - Python stdlib modules (compiled as C extensions)
   - _pkdiagram C++/SIP sources

6. **Libraries**: Static libraries from sysroot
   ```
   LIBS += -lQtCore -lQtGui ... -lpython3.11 -lsip -lssl -lcrypto -lz
   ```

7. **Platform-specific sections**: `macx {}`, `win32 {}`, `linux-* {}`

## Build Process Details

### Step 1: Generate _pkdiagram Sources

```bash
cd _pkdiagram
sip-build --no-compile
moc -o build/_pkdiagram/moc_unsafearea.cpp unsafearea.h
moc -o build/_pkdiagram/moc__pkdiagram.cpp _pkdiagram.h
```

SIP generates Python bindings from `_pkdiagram/sip/_pkdiagram/_pkdiagrammod.sip`. This defines:
- `FDDocument` - Document I/O wrapper
- `CUtil` - Platform utilities (iCloud, file system, crash reporting)
- `PathItemBase` / `PathItemDelegate` - Scene rendering primitives
- `AppFilter` - Application event filtering

### Step 2: Run pyqtdeploy-build

```bash
pyqtdeploy-build --verbose --resources 12 --target macos-64 --build-dir build/osx familydiagram.pdt
```

This command:
1. Reads `familydiagram.pdt` to determine included modules
2. Freezes Python source files into `.pyo` bytecode
3. Generates `.qrc` files embedding the frozen modules
4. Generates `Family Diagram.pro` with all sources and configuration
5. Generates `pyqtdeploy_main.cpp` with extension module table
6. Copies `pyqtdeploy_start.cpp` and `pdytools_module.cpp`

The `--resources 12` flag splits resources across 12 `.qrc` files to avoid compiler limits.

### Step 3: Apply Configuration Overlays

```bash
rsync -avzq build/common-config/* build/osx
rsync -avzq build/osx-config/* build/osx
```

This copies platform-specific assets:
- `Info.plist` (generated from `Info.plist.py`)
- `Family Diagram.entitlements`
- App icons (`.icns` files)
- DMG background image
- xcconfig files

### Step 4: Generate Xcode Project

```bash
cd build/osx && $QMAKE -spec macx-xcode CONFIG+=no_autoqmake [debug/release] [alpha/beta]
```

qmake reads the `.pro` file and:
1. Processes all `include()` directives to merge `.pri` files
2. Evaluates `CONFIG` variables for conditional sections
3. Expands `QMAKE_MAC_XCODE_SETTINGS` into Xcode build settings
4. Generates `Family Diagram.xcodeproj/project.pbxproj`

Key qmake-to-Xcode mappings:
- `SOURCES` → Build Phases → Compile Sources
- `RESOURCES` → Build Phases → Copy Bundle Resources
- `LIBS` → Build Settings → Other Linker Flags
- `INCLUDEPATH` → Build Settings → Header Search Paths
- `QMAKE_MAC_XCODE_SETTINGS` → Build Settings (custom keys)

### Step 5: Fix Workspace Settings

```bash
python3 bin/fixup_xcodeproj_workspace.py
```

Updates `WorkspaceSettings.xcsettings` to use `BuildSystemType = Latest` (new Xcode build system).

### Step 6: Build with xcodebuild

```bash
# Run Qt resource compilation
xcodebuild -project build/osx/Family\ Diagram.xcodeproj \
    -target "Qt Preprocess" \
    -configuration Release

# Build the app
xcodebuild -project build/osx/Family\ Diagram.xcodeproj \
    -scheme "Family Diagram" \
    -configuration Release \
    build
```

## Runtime Architecture

The frozen app embeds Python via `pyqtdeploy_start.cpp`:

1. **Bootstrap**: Sets `Py_FrozenFlag`, `Py_NoSiteFlag`, `Py_IgnoreEnvironmentFlag`
2. **Module table**: `PyImport_ExtendInittab()` registers all extension modules
3. **Interpreter init**: `Py_Initialize()`, `PySys_SetArgvEx()`
4. **Import hook**: `pdytools.qrcimporter` handles imports from Qt resources
5. **Entry point**: `PyImport_Import("pkdiagram.main")`, then `PyObject_CallMethod(mod, "main", NULL)`

The `pdytools_module.cpp` provides a custom import mechanism that:
- Loads `.pyo` files from Qt resource paths (`:/<module>/__init__.pyo`)
- Handles namespace packages
- Supports adjacent extension modules in `PlugIns/` or `Frameworks/`

## Determinism Guarantees

The build system achieves determinism through:

1. **Pinned versions**: All dependencies in `sysroot.toml` have exact versions
2. **Static linking**: Qt and Python are statically linked from sysroot
3. **Frozen bytecode**: Python sources compiled to `.pyo` at build time
4. **No runtime imports**: All modules pre-registered in extension table
5. **Explicit include order**: `.pri` files included in deterministic order
6. **Manual code signing**: Provisioning profile and identity explicitly specified

## Platform Variations

### iOS Differences

- Uses prebuilt Qt 5.15.2 (not built from source)
- No PrintSupport module (sed-patched out of generated files)
- SecureTransport instead of OpenSSL
- Different provisioning profile and bundle ID
- Additional disabled PyQt features (Desktop_OpenGL, MacCocoaViewContainer, etc.)

### Debug vs Release

Debug builds:
- `CONFIG+=debug CONFIG-=release`
- No code signing or hardened runtime
- Symbols not stripped

Release builds:
- `CONFIG-=debug CONFIG+=release`
- Full code signing chain
- Hardened runtime enabled
- dSYM generation for crash symbolication
- Notarization and stapling

## Build Commands Summary

```bash
# Debug build (opens Xcode)
bin/build.sh osx

# Release build with signing and notarization
bin/build.sh osx-release

# iOS (opens Xcode for deployment)
bin/build.sh ios

# Clean all build artifacts
bin/build.sh clean
```

## Environment Variables (Release Builds)

Required secrets for CI/CD:
- `FD_BUILD_PEPPER` - Encryption pepper for app data
- `FD_BUILD_PROVISIONING_PROFILE_BASE64` - Provisioning profile
- `FD_BUILD_CERTIFICATE_BASE64` - Signing certificate
- `FD_BUILD_PRIVATE_KEY_BASE64` - Certificate private key
- `FD_BUILD_AC_AUTH_KEY_ID` - App Store Connect API key ID
- `FD_BUILD_AC_AUTH_KEY_BASE64` - API key content
- `FD_BUILD_AC_AUTH_KEY_ISSUER` - API key issuer ID
